{
  "animatorMap": {
    "COMMENT": "Animation Graph for the Reading Tutor",

    "story_reading": {

      "type": "ANIMATOR",
      "title": "Story Reading Tutor",
      "COMMENT": "",
      "version": "1.0.0",
      "rootnode": "INTRO_STATE",

      "subgraphMap": {

        "SPEAK_WORD_BEHAVIOR": {
          "type": "SUBGRAPH",
          "rootnode": "SPEAK_WORD_MODULE",

          "nodeMap": {
            "SPEAK_WORD_MODULE": {
              "type": "MODULE",
              "COMMENT": "Speak the current word and continue to next.",
              "preenter": [],
              "reuse": true,
              "tracks": [
                {"type": "AUDIO", "command": "PLAY", "soundsource": "{{SstoryReading.currentWord}}.mp3","soundpackage": "words","mode": "flow", "features": ""},

                {"type": "COMMAND", "id": "SstoryReading", "method": "nextWord" ,"features":""}
              ],
              "preexit": [
                "SET_ONCLICK_SPEAK_WORD","RETURN_AND_GO","WAIT"
              ],
              "edges": [
              ]
            }
          }
        },

        "SPEAK_SENTENCE_BEHAVIOR": {
          "type": "SUBGRAPH",
          "rootnode": "SPEAK_SENTENCE_MODULE",

          "nodeMap": {
            "SPEAK_SENTENCE_MODULE": {
              "type": "MODULE",
              "COMMENT": "Speak the current word and continue to next.",
              "preenter": [],
              "reuse": true,
              "tracks": [
                {"type": "AUDIO", "command": "PLAY", "soundsource": "{{SstoryReading.sentence}}.mp3","soundpackage": "words","mode": "flow", "features": ""},

                {"type": "COMMAND", "id": "SstoryReading", "method": "nextSentence" ,"features":""}
              ],
              "preexit": [
              ],
              "edges": [
              ]
            }
          }
        }

      },

      "nodeMap": {

        "COMMENT": "@@@@@  CNodes  @@@@@",

        "INTRO_STATE": {
          "type": "NODE",
          "COMMENT": "Intro Clip",
          "preenter":["SET_VERSION"],
          "maptype":"moduleMap",
          "mapname": "PLAYINTRO",
          "preexit" :[],
          "edges": [
            {"constraint": "", "edge": "NEXT_STEP"}
          ]
        },

        "NEXT_STEP":{
          "COMMENT":"When user inputs a correct answer...",
          "type":"node",
          "maptype":"moduleMap",
          "mapname": "CHECK_COMPLETE",
          "preenter":[],
          "preexit" :[],
          "edges":
          [
            {"constraint":"STORY_STARTING","edge":"BEGIN_STORY"},
            {"constraint":"STORY_COMPLETE","edge":"NEXT_SCENE"},
            {"constraint":"PAGE_COMPLETE","edge":"NEXT_PAGE_NODE"},
            {"constraint":"PARAGRAPH_COMPLETE","edge":"NEXT_PARA_NODE"},
            {"constraint":"LINE_COMPLETE","edge":"NEXT_LINE_NODE"},
            {"constraint":"","edge":"NEXT_WORD_NODE"}
          ]
        },

        "BEGIN_STORY": {
          "type": "NODE",
          "COMMENT": "",
          "maptype":"actionMap",
          "mapname":"START_STORY",
          "preenter": [],
          "preexit": [],
          "edges": [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        "LISTEN":{
          "COMMENT":"",
          "type":"node",
          "preenter":["SET_HYPOTHESIS_BEHAVIOR","SET_ONCLICK_SPEAK_WORD","TIMER_HINT_WORD"],
          "maptype":"moduleMap",
          "mapname": "LISTENING",
          "preexit" :["CLR_HYPOTHESIS_BEHAVIOR","CLR_ONCLICK","TIMER_CANCEL_HINT_WORD"],
          "edges":
          [
            {"constraint":"FTR_RIGHT","edge":"CORRECT"},
            {"constraint":"FIRST_ATTEMPT","edge":"WRONG_1"},
            {"constraint":"SECOND_ATTEMPT","edge":"WRONG_2"},
            {"constraint":"","edge":"WRONG_3"}
          ]
        },

        "CORRECT":{
          "COMMENT":"When user inputs a correct answer...",
          "type":"node",
          "maptype":"moduleMap",
          "mapname": "PLAYCORRECT",
          "preenter":[],
          "preexit" :[],
          "edges":
          [
            {"constraint":"","edge":"NEXT_STEP"}
          ]
        },

        "WRONG_1":{
          "COMMENT":"When user says an incorrect word...",
          "type":"node",
          "maptype":"moduleMap",
          "preenter":[],
          "mapname": "PLAYWRONG",
          "preexit" :[],
          "edges":
          [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        "WRONG_2":{
          "COMMENT":"When user says an incorrect word...",
          "type":"node",
          "maptype":"moduleMap",
          "preenter":["SPEAK_BUTTON_ENABLE","SPEAK_BUTTON_SHOW","SET_SPEAK_WORD"],
          "mapname": "PLAYWRONG",
          "preexit" :[],
          "edges":
          [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        "WRONG_3":{
          "COMMENT":"When user says an incorrect word...",
          "type":"node",
          "maptype":"moduleMap",
          "preenter":[],
          "mapname": "PLAYWRONG",
          "preexit" :[],
          "edges":
          [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        "NEXT_WORD_NODE": {
          "type": "NODE",
          "COMMENT": "When module is complete - move to next scene in the scenegraph",
          "maptype":"moduleMap",
          "mapname":"PREP_NEXT_WORD",
          "preenter": [],
          "preexit": [],
          "edges": [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        "NEXT_LINE_NODE": {
          "type": "NODE",
          "COMMENT": "When module is complete - move to next scene in the scenegraph",
          "maptype":"actionMap",
          "mapname":"NEXT_LINE",
          "preenter": [],
          "preexit": [],
          "edges": [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        "NEXT_PARA_NODE": {
          "type": "NODE",
          "COMMENT": "When module is complete - move to next scene in the scenegraph",
          "maptype":"actionMap",
          "mapname":"NEXT_PARA",
          "preenter": [],
          "preexit": [],
          "edges": [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        // If you want it to automatically advance the page use - AUTO_PAGEFLIP
        //
        "NEXT_PAGE_NODE": {
          "type": "NODE",
          "COMMENT": "When module is complete - move to next scene in the scenegraph",
          "maptype":"moduleMap",
          "mapname":"PAGEFLIP",
          "preenter": [],
          "preexit": [],
          "edges": [
            {"constraint":"","edge":"LISTEN"}
          ]
        },

        "NEXT_SCENE": {
          "type": "NODE",
          "COMMENT": "When module is complete - move to next scene in the scenegraph",
          "maptype":"moduleMap",
          "mapname":"SCENEFLIP",
          "preenter": [],
          "preexit": [],
          "edges": [
          ]
        }
      },

      "moduleMap": {

        "COMMENT": "@@@@@  CModules  @@@@@",
        "PLAYINTRO":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
            {"type": "AUDIO", "command": "PLAY", "soundsource": "Please read the story aloud.mp3", "mode":"flow","features": "LANG_SW"},
            {"type": "AUDIO", "command": "PLAY", "soundsource": "Please read aloud.mp3", "mode":"flow","features": "LANG_EN"}
          ]
        },

        "LISTENING":{
          "type":"MODULE",
          "reuse":true,
          "COMMENT": "Listening Module",
          "tracks": [
            {"type": "COMMAND", "cmd": "WAIT" }
          ]
        },

        "PLAYCORRECT":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
          ]
        },

        "CHECK_COMPLETE":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
            {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",        "parms": "HIDE:String",    "features": "" }
          ]
        },

        "NULL_MODULE":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
          ]
        },

        "PREP_NEXT_WORD":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
            {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",        "parms": "HIDE:String",    "features": "" },
            {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",     "parms": "DISABLE:String", "features": "FTR_MANUAL" }
          ]
        },


        "CONFIG_SPEAK_BUTTON":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
            // NOTE: the button must be in a valid state before showing
            // TODO: put check in to catch invalid behaviors

            {"type": "COMMAND", "id":"SstoryReading", "method":"setVolatileBehavior", "parms": "SPEAK_CLICK:String|SPEAK_WORD_BEHAVIOR:String" ,"features":""},
            {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",      "parms": "ENABLE:String",     "features": "" },
            {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",      "parms": "SHOW:String",       "features": "" }
          ]
        },

        "PAGEFLIP":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
            {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",    "parms": "ENABLE:String",                   "features": "FTR_MANUAL" },
            {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ON_PAGE_FLIP:String|NEXT_NODE:String" ,"features":"FTR_MANUAL"},

            {"type": "COMMAND", "cmd": "WAIT",                                                                   "features": "FTR_MANUAL" },

            {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",   "parms": "DISABLE:String", "features": "FTR_MANUAL" },
            {"type": "COMMAND", "id":"SstoryReading", "method": "nextPage"                                     , "features":""}
          ]
        },

        "SCENEFLIP":{
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
            {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",    "parms": "ENABLE:String",                   "features": "FTR_MANUAL" },
            {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ON_PAGE_FLIP:String|NEXT_NODE:String" ,"features":"FTR_MANUAL"},

            {"type": "COMMAND", "cmd": "WAIT",                                                                   "features": "FTR_MANUAL" },

            {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",   "parms": "DISABLE:String", "features": "FTR_MANUAL" },
            {"type": "COMMAND", "cmd": "NEXTSCENE" }
          ]
        },

        "PLAYWRONG": {
          "type": "MODULE",
          "reuse":true,
          "COMMENT": "TBD",
          "tracks": [
            {"type": "COMMAND", "id": "SstoryReading", "method": "setHighLight", "parms": "red:String"},
            {"type": "COMMAND", "id": "SstoryReading", "method": "continueListening"  ,"features":""}
          ]
        }
      },

      "actionMap": {

        "COMMENT": "@@@@@  CActions @@@@@ ",

        "SET_VERSION":{"type": "COMMAND", "id": "Sbanner", "method": "setVersionID", "parms": "v.0.0.1:String","features":""},

        "START_STORY":{"type": "COMMAND", "id": "SstoryReading", "method": "startStory", "features":""},

        "HESTITATION_TIMER":   {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ASR_TIMED_START_EVENT:String|HESITATION_PROMPT:String|5000:Integer" ,"features":""},
        "HESTITATION_RESET":   {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ASR_TIMED_START_EVENT:String|NULL:String|0:Integer" ,"features":""},

        "SET_WORD_EVENT":   {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ASR_WORD_EVENT:String|HESTITATION_RESET:String" ,"features":""},
        "RESET_WORD_EVENT": {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ASR_WORD_EVENT:String|NULL:String" ,"features":""},

        "SET_ONCLICK_SPEAK_WORD": {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ON_CLICK:String|SPEAK_WORD_BEHAVIOR:String" ,"features":""},
        "CLR_ONCLICK":            {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ON_CLICK:String|NULL:String" ,"features":""},

        "SET_HYPOTHESIS_BEHAVIOR":   {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ASR_RECOGNITION_EVENT:String|NEXT_NODE:String" ,"features":""},
        "CLR_HYPOTHESIS_BEHAVIOR":  {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "ASR_RECOGNITION_EVENT:String|NULL:String" ,"features":""},

        "HIGHLIGHT_ERROR": {"type": "COMMAND", "id": "SstoryReading", "method": "setHighLight", "parms": "red:String"},
        "CONTINUE":        {"type": "COMMAND", "id": "SstoryReading", "method": "continueListening"  ,"features":""},

        "NEXT_WORD":{"type": "COMMAND", "id": "SstoryReading", "method": "nextWord" ,"features":""},
        "NEXT_LINE":{"type": "COMMAND", "id": "SstoryReading", "method": "nextLine" ,"features":""},
        "NEXT_PARA":{"type": "COMMAND", "id": "SstoryReading", "method": "nextPara" ,"features":""},
        "NEXT_PAGE":{"type": "COMMAND", "id": "SstoryReading", "method": "nextPage" ,"features":""},

        "TIMER_HINT_WORD":        {"type": "TIMER", "id":"HintWordTimer", "startdelay":"0", "period":"3500", "repeat":"false", "action":"CREATEANDSTART", "ontimer":"CONFIG_SPEAK_BUTTON", "features": "FTR_MANUAL" },
        "TIMER_CANCEL_HINT_WORD": {"type": "TIMER", "id":"HintWordTimer", "action":"CANCEL", "features": "FTR_MANUAL" },

        "FLIP_BUTTON_ENABLE":  {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",     "parms": "ENABLE:String", "features": "" },
        "FLIP_BUTTON_DISABLE": {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",     "parms": "DISABLE:String", "features": "" },
        "FLIP_BUTTON_SHOW":    {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",     "parms": "SHOW:String", "features": "" },
        "FLIP_BUTTON_HIDE":    {"type": "COMMAND", "id":"SstoryReading", "method":"setPageFlipButton",     "parms": "HIDE:String", "features": "" },

        "SPEAK_BUTTON_ENABLE":  {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",     "parms": "ENABLE:String",  "features": "" },
        "SPEAK_BUTTON_DISABLE": {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",     "parms": "DISABLE:String", "features": "" },
        "SPEAK_BUTTON_SHOW":    {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",     "parms": "SHOW:String",    "features": "" },
        "SPEAK_BUTTON_HIDE":    {"type": "COMMAND", "id":"SstoryReading", "method":"setSpeakButton",     "parms": "HIDE:String",    "features": "" },

        "SET_FLIP_NEXTPAGE":   {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "PAGE_FLIP_CLICK:String|NEXT_PAGE:String" ,"features":""},
        "RESET_FLIP_ONCLICK":  {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "PAGE_FLIP_CLICK:String|NULL:String" ,"features":""},

        "SET_SPEAK_WORD":      {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "SPEAK_CLICK:String|SPEAK_WORD_BEHAVIOR:String" ,"features":""},
        "SET_SPEAK_SENTENCE":  {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "SPEAK_CLICK:String|SPEAK_SENTENCE_BEHAVIOR:String" ,"features":""},
        "RESET_SPEAK_ONCLICK": {"type": "COMMAND", "id":"SstoryReading", "method": "setVolatileBehavior", "parms": "SPEAK_CLICK:String|NULL:String" ,"features":""},

        "EMPTY_ACTION":    {"type": "COMMAND", "cmd": "NOOP" },
        "GOTONEXTSCENE":   {"type": "COMMAND", "cmd": "NEXTSCENE" },
        "RETURN_AND_GO":   {"type": "COMMAND", "cmd": "SUBGRAPH_RETURN_AND_GO"},
        "RETURN_AND_WAIT": {"type": "COMMAND", "cmd": "SUBGRAPH_RETURN_AND_WAIT"},
        "CANCEL_FEEDBACK": {"type": "COMMAND", "cmd": "CANCEL_NODE"},
        "NEXT_NODE":       {"type": "COMMAND", "cmd": "NEXT"  },
        "WAIT":            {"type": "COMMAND", "cmd": "WAIT"  },
        "PAUSE":           {"type": "COMMAND", "cmd": "WAIT" }
      },

      "constraintMap": {

        "COMMENT": "@@@@@  CConstraints @@@@@ ",

        "FIRST_ATTEMPT": {
          "type": "CONDITION",
          "If": "{{SstoryReading.attempt}}==1",
          "Then":"true",
          "Else":"false"
        },

        "SECOND_ATTEMPT": {
          "type": "CONDITION",
          "If": "{{SstoryReading.attempt}}==2",
          "Then":"true",
          "Else":"false"
        },

        // Note that we don't have operator precidence so we must use ( ) to enforce precidence
        //
        "STORY_COMPLETE": {
          "type": "CONDITION",
          "If": "({{SstoryReading.pageState}}=='LAST') && ({{SstoryReading.paraState}}=='LAST') && ({{SstoryReading.lineState}}=='LAST') && ({{SstoryReading.wordState}}=='LAST')",
          "Then":"true",
          "Else":"false"
        },

        "PAGE_COMPLETE": {
          "type": "CONDITION",
          "If": "({{SstoryReading.paraState}}=='LAST') && ({{SstoryReading.lineState}}=='LAST') && ({{SstoryReading.wordState}}=='LAST')",
          "Then":"true",
          "Else":"false"
        },

        "PARAGRAPH_COMPLETE": {
          "type": "CONDITION",
          "If": "({{SstoryReading.lineState}}=='LAST') && ({{SstoryReading.wordState}}=='LAST')",
          "Then":"true",
          "Else":"false"
        },

        "LINE_COMPLETE": {
          "type": "CONDITION",
          "If": "{{SstoryReading.wordState}}=='LAST'",
          "Then":"true",
          "Else":"false"
        },

        "STORY_STARTING": {
            "type": "CONDITION",
            "test":"FTR_STORY_STARTING"
          },

        "FTR_RIGHT":{
          "type": "CONDITION",
          "test":"FTR_RIGHT"
        },

        "FTR_WRONG":{
          "type": "CONDITION",
          "test":"FTR_WRONG"
        }
      }
    }
  }
}